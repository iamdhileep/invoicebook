<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="alert alert-warning">
            <h4>üîç Face Recognition Test - Step by Step</h4>
            <p>This page will help diagnose Face Recognition issues</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6>Browser Compatibility Check</h6>
                    </div>
                    <div class="card-body" id="compatibilityCheck">
                        <p>Checking browser capabilities...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6>Camera Access Test</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary w-100" onclick="testCameraAccess()">
                            <i class="bi bi-camera"></i> Test Camera Access
                        </button>
                        <div id="cameraTest" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6>Face Recognition Simulation</h6>
                    </div>
                    <div class="card-body">
                        <div id="faceArea" style="min-height: 300px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center;">
                            <div class="text-center">
                                <i class="bi bi-camera text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">Camera preview will appear here</p>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <button class="btn btn-success" onclick="startFaceRecognition()">
                                <i class="bi bi-person-check"></i> Start Face Recognition
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <a href="pages/attendance/attendance.php" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Attendance Page
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStream = null;

        // Check browser compatibility
        function checkCompatibility() {
            const compatibility = document.getElementById('compatibilityCheck');
            const checks = [];

            // Check getUserMedia support
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                checks.push('<span class="text-success">‚úÖ Camera API supported</span>');
            } else {
                checks.push('<span class="text-danger">‚ùå Camera API not supported</span>');
            }

            // Check HTTPS requirement (camera requires HTTPS in production)
            if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                checks.push('<span class="text-success">‚úÖ Secure context (HTTPS/localhost)</span>');
            } else {
                checks.push('<span class="text-warning">‚ö†Ô∏è May require HTTPS for camera access</span>');
            }

            // Check browser type
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) {
                checks.push('<span class="text-success">‚úÖ Chrome browser (good camera support)</span>');
            } else if (userAgent.includes('Firefox')) {
                checks.push('<span class="text-success">‚úÖ Firefox browser (good camera support)</span>');
            } else if (userAgent.includes('Safari')) {
                checks.push('<span class="text-info">‚ÑπÔ∏è Safari browser (may have restrictions)</span>');
            } else {
                checks.push('<span class="text-warning">‚ö†Ô∏è Unknown browser - camera support may vary</span>');
            }

            compatibility.innerHTML = checks.join('<br>');
        }

        // Test camera access
        function testCameraAccess() {
            const testArea = document.getElementById('cameraTest');
            testArea.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><br>Requesting camera access...</div>';

            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    testArea.innerHTML = '<div class="alert alert-success">‚úÖ Camera access granted!</div>';
                    // Stop the stream immediately (this was just a test)
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(error => {
                    let errorMsg = 'Camera access failed: ';
                    if (error.name === 'NotAllowedError') {
                        errorMsg += 'Permission denied by user';
                    } else if (error.name === 'NotFoundError') {
                        errorMsg += 'No camera found';
                    } else if (error.name === 'NotReadableError') {
                        errorMsg += 'Camera is being used by another application';
                    } else {
                        errorMsg += error.message;
                    }
                    testArea.innerHTML = `<div class="alert alert-danger">‚ùå ${errorMsg}</div>`;
                });
        }

        // Start face recognition
        function startFaceRecognition() {
            const faceArea = document.getElementById('faceArea');
            
            // Show loading
            faceArea.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p>Initializing camera...</p>
                </div>
            `;

            // Clean up existing stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            })
            .then(stream => {
                currentStream = stream;
                
                // Create video element
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                video.style.cssText = 'width:100%; max-width:640px; height:auto; border-radius:8px;';

                faceArea.innerHTML = '';
                faceArea.appendChild(video);

                // Add controls
                const controls = document.createElement('div');
                controls.className = 'mt-3 text-center';
                controls.innerHTML = `
                    <button class="btn btn-success me-2" onclick="simulateRecognition()">
                        <i class="bi bi-check-circle"></i> Simulate Recognition Success
                    </button>
                    <button class="btn btn-danger" onclick="stopCamera()">
                        <i class="bi bi-stop-circle"></i> Stop Camera
                    </button>
                `;
                faceArea.appendChild(controls);
            })
            .catch(error => {
                let errorMsg = 'Failed to start camera: ';
                if (error.name === 'NotAllowedError') {
                    errorMsg += 'Camera permission denied. Please allow camera access and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += 'No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    errorMsg += 'Camera is being used by another application.';
                } else {
                    errorMsg += error.message;
                }

                faceArea.innerHTML = `
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                        <p class="text-danger mt-3">${errorMsg}</p>
                        <button class="btn btn-outline-primary" onclick="startFaceRecognition()">
                            <i class="bi bi-arrow-clockwise"></i> Try Again
                        </button>
                    </div>
                `;
            });
        }

        function simulateRecognition() {
            const faceArea = document.getElementById('faceArea');
            
            // Stop camera
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }

            // Show success message
            faceArea.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-person-check-fill text-success" style="font-size: 4rem;"></i>
                    <div class="alert alert-success mt-3 mb-3">
                        <strong>Face Recognition Successful!</strong>
                        <br>Person identified: Demo User
                    </div>
                    <button class="btn btn-primary" onclick="resetTest()">
                        <i class="bi bi-arrow-clockwise"></i> Test Again
                    </button>
                </div>
            `;
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            resetTest();
        }

        function resetTest() {
            const faceArea = document.getElementById('faceArea');
            faceArea.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-camera text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">Camera preview will appear here</p>
                </div>
            `;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            checkCompatibility();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
