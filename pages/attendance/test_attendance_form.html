<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Form Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="alert alert-info">
            <h4>üß™ Attendance Form Save Test</h4>
            <p>This page will test the form submission to save_attendance.php to identify the exact issue.</p>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Test Attendance Form</h5>
                    </div>
                    <div class="card-body">
                        <form action="../../save_attendance.php" method="POST" id="testAttendanceForm">
                            <input type="hidden" name="attendance_date" value="<?= date('Y-m-d') ?>">
                            
                            <h6>Sample Employee Data</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Status</th>
                                            <th>Punch In</th>
                                            <th>Punch Out</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <strong>Test Employee 1</strong><br>
                                                <small class="text-muted">EMP001</small>
                                                <input type="hidden" name="employee_id[]" value="1">
                                            </td>
                                            <td>
                                                <select name="status[1]" class="form-select form-select-sm">
                                                    <option value="Present" selected>Present</option>
                                                    <option value="Absent">Absent</option>
                                                    <option value="Late">Late</option>
                                                    <option value="Half Day">Half Day</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="time" name="time_in[1]" class="form-control form-control-sm" value="09:00">
                                            </td>
                                            <td>
                                                <input type="time" name="time_out[1]" class="form-control form-control-sm" value="17:00">
                                            </td>
                                            <td>
                                                <input type="text" name="notes[1]" class="form-control form-control-sm" value="Test note 1">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <strong>Test Employee 2</strong><br>
                                                <small class="text-muted">EMP002</small>
                                                <input type="hidden" name="employee_id[]" value="2">
                                            </td>
                                            <td>
                                                <select name="status[2]" class="form-select form-select-sm">
                                                    <option value="Present">Present</option>
                                                    <option value="Absent" selected>Absent</option>
                                                    <option value="Late">Late</option>
                                                    <option value="Half Day">Half Day</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input type="time" name="time_in[2]" class="form-control form-control-sm" value="">
                                            </td>
                                            <td>
                                                <input type="time" name="time_out[2]" class="form-control form-control-sm" value="">
                                            </td>
                                            <td>
                                                <input type="text" name="notes[2]" class="form-control form-control-sm" value="Absent today">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-3">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-save"></i> Test Save Attendance
                                </button>
                                <button type="button" class="btn btn-info" onclick="debugFormData()">
                                    <i class="bi bi-bug"></i> Debug Form Data
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6>Debug Console</h6>
                    </div>
                    <div class="card-body">
                        <div id="debugOutput" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px; border: 1px solid #ddd;">
                            <div>Debug console ready...</div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6>Expected Data Structure</h6>
                    </div>
                    <div class="card-body">
                        <pre style="font-size: 11px;">
attendance_date: <?= date('Y-m-d') ?>

employee_id[]: [1, 2]
status[1]: Present
status[2]: Absent
time_in[1]: 09:00
time_in[2]: 
time_out[1]: 17:00
time_out[2]: 
notes[1]: Test note 1
notes[2]: Absent today
                        </pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <a href="../attendance/attendance.php" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Main Attendance Page
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function debugLog(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        function debugFormData() {
            const form = document.getElementById('testAttendanceForm');
            const formData = new FormData(form);
            
            debugLog('=== FORM DATA DEBUG ===');
            debugLog('Form action: ' + form.action);
            debugLog('Form method: ' + form.method);
            debugLog('');
            
            for (let [key, value] of formData.entries()) {
                debugLog(`${key}: ${value}`);
            }
            
            debugLog('');
            debugLog('Employee IDs: ' + JSON.stringify(formData.getAll('employee_id[]')));
            debugLog('Status keys: ' + Object.keys(Object.fromEntries(formData.entries())).filter(k => k.startsWith('status[')).join(', '));
        }

        // Add form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('testAttendanceForm');
            form.addEventListener('submit', function(e) {
                debugLog('üöÄ Form submission started');
                
                const formData = new FormData(this);
                debugLog('üìù Submitting ' + formData.getAll('employee_id[]').length + ' employee records');
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
                }
                
                debugLog('‚úÖ Form submitted to: ' + this.action);
            });
            
            debugLog('‚úÖ Test form initialized');
        });

        // Check for URL parameters
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('success')) {
                const count = urlParams.get('count') || 'unknown';
                const date = urlParams.get('date') || 'today';
                debugLog(`‚úÖ SUCCESS: Saved ${count} records for ${date}`);
                
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = `<i class="bi bi-check-circle"></i> <strong>Success!</strong> Saved attendance for ${count} employees on ${date}`;
                document.body.insertBefore(alert, document.body.firstChild);
            }
            
            if (urlParams.has('error')) {
                const message = urlParams.get('message') || 'Unknown error';
                debugLog(`‚ùå ERROR: ${decodeURIComponent(message)}`);
                
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                alert.innerHTML = `<i class="bi bi-exclamation-triangle"></i> <strong>Error!</strong> ${decodeURIComponent(message)}`;
                document.body.insertBefore(alert, document.body.firstChild);
            }
        });
    </script>
</body>
</html>
