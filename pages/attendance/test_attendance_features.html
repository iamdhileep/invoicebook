<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>Attendance System Feature Test
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Test Mode Active</h6>
                            <p class="mb-0">
                                This test page runs in <strong>test_mode=true</strong> to bypass authentication requirements. 
                                In production, users must be logged in to access these APIs.
                            </p>
                        </div>
                        
                        <div id="testResults" class="mb-4"></div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">API Tests</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="testAPI('attendance_summary')">
                                                <i class="bi bi-graph-up"></i> Test Attendance Summary
                                            </button>
                                            <button class="btn btn-outline-success" onclick="testAPI('punch_in')">
                                                <i class="bi bi-box-arrow-in-right"></i> Test Punch In API
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="testAPI('punch_out')">
                                                <i class="bi bi-box-arrow-left"></i> Test Punch Out API
                                            </button>
                                            <button class="btn btn-outline-info" onclick="testAPI('face_recognition')">
                                                <i class="bi bi-person-check"></i> Test Face Recognition
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Feature Tests</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-warning" onclick="testGeoLocation()">
                                                <i class="bi bi-geo-alt"></i> Test Geo Location
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="testQRCode()">
                                                <i class="bi bi-qr-code-scan"></i> Test QR Code
                                            </button>
                                            <button class="btn btn-outline-primary" onclick="testMobileConnection()">
                                                <i class="bi bi-phone"></i> Test Mobile Connection
                                            </button>
                                            <button class="btn btn-outline-success" onclick="testFormSubmission()">
                                                <i class="bi bi-check-circle"></i> Test Form Submission
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Test Employee</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Employee ID</label>
                                            <input type="number" id="testEmployeeId" class="form-control" value="1" placeholder="Enter Employee ID">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Action</label>
                                            <select id="testAction" class="form-select">
                                                <option value="punch_in">Punch In</option>
                                                <option value="punch_out">Punch Out</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Method</label>
                                            <select id="testMethod" class="form-select">
                                                <option value="manual">Manual</option>
                                                <option value="biometric">Biometric</option>
                                                <option value="mobile_app">Mobile App</option>
                                                <option value="qr_scan">QR Scan</option>
                                                <option value="geo_location">Geo Location</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" onclick="runCustomTest()">
                                            <i class="bi bi-play-circle"></i> Run Custom Test
                                        </button>
                                        <button class="btn btn-success ms-2" onclick="runAllTests()">
                                            <i class="bi bi-check-all"></i> Run All Tests
                                        </button>
                                        <button class="btn btn-secondary ms-2" onclick="clearResults()">
                                            <i class="bi bi-trash"></i> Clear Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Navigation Tests</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <a href="attendance.php" class="btn btn-outline-primary w-100">
                                                <i class="bi bi-calendar-check"></i> Test Attendance Page
                                            </a>
                                        </div>
                                        <div class="col-md-4">
                                            <a href="../../save_attendance.php" class="btn btn-outline-warning w-100">
                                                <i class="bi bi-save"></i> Test Save Script
                                            </a>
                                        </div>
                                        <div class="col-md-4">
                                            <a href="process_leave_request.php" class="btn btn-outline-info w-100">
                                                <i class="bi bi-calendar-plus"></i> Test Leave Process
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Session & Authentication Tests</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <h6>Test Login (Alternative to test_mode)</h6>
                                            <div class="mb-2">
                                                <input type="text" id="testUsername" class="form-control form-control-sm" placeholder="Username: test" value="test">
                                            </div>
                                            <div class="mb-2">
                                                <input type="password" id="testPassword" class="form-control form-control-sm" placeholder="Password: test123" value="test123">
                                            </div>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-success" onclick="testLogin()">
                                                    <i class="bi bi-box-arrow-in-right"></i> Login
                                                </button>
                                                <button class="btn btn-info" onclick="checkLoginStatus()">
                                                    <i class="bi bi-person-check"></i> Check Status
                                                </button>
                                                <button class="btn btn-secondary" onclick="testLogout()">
                                                    <i class="bi bi-box-arrow-right"></i> Logout
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Session-based API Test</h6>
                                            <p class="small text-muted">After logging in, these APIs will work without test_mode</p>
                                            <div class="btn-group-vertical btn-group-sm w-100" role="group">
                                                <button class="btn btn-outline-primary" onclick="testAPIWithSession('attendance_summary')">
                                                    Test Summary (with session)
                                                </button>
                                                <button class="btn btn-outline-success" onclick="testAPIWithSession('punch_in')">
                                                    Test Punch In (with session)
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/geolocation-manager.js"></script>
    <script>
        let testCounter = 0;
        
        function showResult(message, type = 'info') {
            testCounter++;
            const resultsDiv = document.getElementById('testResults');
            const alertClass = `alert-${type}`;
            const icon = type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : 'info-circle';
            
            resultsDiv.innerHTML += `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="bi bi-${icon} me-2"></i>
                    <strong>Test ${testCounter}:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        function testAPI(endpoint) {
            showResult(`Testing API endpoint: ${endpoint}...`, 'info');
            
            const employeeId = document.getElementById('testEmployeeId').value || 1;
            let apiUrl = '';
            let requestData = {};
            
            switch(endpoint) {
                case 'attendance_summary':
                    apiUrl = 'api/biometric_api.php?action=attendance_summary&test_mode=true&date=' + new Date().toISOString().split('T')[0];
                    fetch(apiUrl)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showResult(`✅ Attendance Summary API working! Total employees: ${data.data.total_employees || 0}`, 'success');
                            } else {
                                showResult(`❌ API Error: ${data.message}`, 'danger');
                            }
                        })
                        .catch(error => {
                            showResult(`❌ Network Error: ${error.message}`, 'danger');
                        });
                    break;
                    
                case 'punch_in':
                    apiUrl = 'api/biometric_api.php?action=punch_in&test_mode=true';
                    requestData = {
                        employee_id: parseInt(employeeId),
                        method: 'test',
                        timestamp: new Date().toISOString()
                    };
                    
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showResult(`✅ Punch In API working! Time: ${data.data.time_in}, Status: ${data.data.status}`, 'success');
                        } else {
                            showResult(`⚠️ API Response: ${data.message}`, 'warning');
                        }
                    })
                    .catch(error => {
                        showResult(`❌ Punch In Error: ${error.message}`, 'danger');
                    });
                    break;
                    
                case 'punch_out':
                    apiUrl = 'api/biometric_api.php?action=punch_out&test_mode=true';
                    requestData = {
                        employee_id: parseInt(employeeId),
                        method: 'test'
                    };
                    
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showResult(`✅ Punch Out API working! Duration: ${data.data.duration}`, 'success');
                        } else {
                            showResult(`⚠️ API Response: ${data.message}`, 'warning');
                        }
                    })
                    .catch(error => {
                        showResult(`❌ Punch Out Error: ${error.message}`, 'danger');
                    });
                    break;
                    
                case 'face_recognition':
                    apiUrl = 'api/biometric_api.php?action=face_recognition&test_mode=true';
                    requestData = {
                        image_data: 'test_image_base64',
                        expected_employee_id: parseInt(employeeId),
                        confidence: 95
                    };
                    
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        showResult(`✅ Face Recognition API tested. Response: ${data.message}`, data.success ? 'success' : 'warning');
                    })
                    .catch(error => {
                        showResult(`❌ Face Recognition Error: ${error.message}`, 'danger');
                    });
                    break;
            }
        }
        
        async function testGeoLocation() {
            showResult('Testing Enhanced Geo Location...', 'info');
            
            try {
                // Use the enhanced geolocation manager
                if (typeof window.testGeolocationWithFallback === 'function') {
                    const result = await window.testGeolocationWithFallback();
                    
                    if (result.success) {
                        if (result.isMock) {
                            showResult(`⚠️ ${result.message} (Mock location for testing)`, 'warning');
                        } else {
                            showResult(`✅ ${result.message}`, 'success');
                        }
                        
                        // Test the API with the coordinates
                        if (result.position) {
                            testGeoAPI(result.position.latitude, result.position.longitude, result.position.accuracy || 10);
                        }
                    } else {
                        showResult(`❌ Geolocation Test Failed: ${result.message}`, 'danger');
                        
                        // Show instructions for enabling location
                        if (result.message.includes('permission') || result.message.includes('denied')) {
                            showResult(`💡 To enable location: Look for location icon in browser address bar and click "Allow"`, 'info');
                        }
                        
                        // Try fallback test
                        testGeoLocationFallback();
                    }
                } else {
                    // Fallback to basic test if enhanced manager not loaded
                    showResult('⚠️ Enhanced geolocation manager not available, using basic test...', 'warning');
                    testGeoLocationBasic();
                }
            } catch (error) {
                showResult(`❌ Geolocation Error: ${error.message}`, 'danger');
                testGeoLocationFallback();
            }
        }
        
        function testGeoLocationBasic() {
            if (!navigator.geolocation) {
                showResult('❌ Geolocation not supported by this browser', 'danger');
                return;
            }
            
            // Check if geolocation is available and not blocked by permissions policy
            if (typeof navigator.permissions !== 'undefined') {
                navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
                    if (result.state === 'denied') {
                        showResult(`⚠️ Geolocation Permission: ${result.state}. Using fallback test.`, 'warning');
                        testGeoLocationFallback();
                        return;
                    }
                    
                    // Try to get actual location
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            showResult(`✅ Geo Location working! Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}, Accuracy: ${accuracy}m`, 'success');
                            
                            // Test the geo API with real coordinates
                            testGeoAPI(lat, lng, accuracy);
                        },
                        function(error) {
                            let errorMsg = 'Unknown error';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg = 'Permission denied by user or browser policy';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg = 'Location information unavailable';
                                    break;
                                case error.TIMEOUT:
                                    errorMsg = 'Location request timeout';
                                    break;
                            }
                            showResult(`⚠️ Geo Location Error: ${errorMsg}. Using fallback test.`, 'warning');
                            testGeoLocationFallback();
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                }).catch(function() {
                    // Permissions API not supported, try direct geolocation
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            showResult(`✅ Geo Location working! Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
                            testGeoAPI(lat, lng, position.coords.accuracy);
                        },
                        function(error) {
                            showResult(`⚠️ Geo Location blocked or unavailable. Using fallback test.`, 'warning');
                            testGeoLocationFallback();
                        }
                    );
                });
            } else {
                // Direct geolocation test for older browsers
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        showResult(`✅ Geo Location working! Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
                        testGeoAPI(lat, lng, position.coords.accuracy);
                    },
                    function(error) {
                        showResult(`⚠️ Geo Location Error: ${error.message}. Using fallback test.`, 'warning');
                        testGeoLocationFallback();
                    }
                );
            }
        }
        
        function testGeoLocationFallback() {
            showResult('🔄 Running Geo Location API test with mock coordinates...', 'info');
            
            // Use mock coordinates for testing (Bangalore, India)
            const mockLat = 12.9716;
            const mockLng = 77.5946;
            const mockAccuracy = 10;
            
            showResult(`📍 Using mock location: Lat: ${mockLat}, Lng: ${mockLng} (Bangalore, India)`, 'info');
            testGeoAPI(mockLat, mockLng, mockAccuracy);
        }
        
        function testGeoAPI(latitude, longitude, accuracy) {
            const employeeId = document.getElementById('testEmployeeId').value || 1;
            
            showResult('🔄 Testing Geo Location API with coordinates...', 'info');
            
            fetch('api/biometric_api.php?action=geo_checkin&test_mode=true', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_id: parseInt(employeeId),
                    latitude: latitude,
                    longitude: longitude,
                    accuracy: accuracy
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResult(`✅ Geo API Test: ${data.message}`, 'success');
                } else {
                    const distance = data.data ? data.data.distance : 'unknown';
                    showResult(`⚠️ Geo API Test: ${data.message} (Distance: ${distance}m)`, 'warning');
                }
            })
            .catch(error => {
                showResult(`❌ Geo API Error: ${error.message}`, 'danger');
            });
        }
        
        function testQRCode() {
            showResult('Testing QR Code generation...', 'info');
            
            const employeeCode = 'EMP001';
            const action = 'PUNCH_IN';
            const timestamp = new Date().toISOString();
            const qrData = `${employeeCode}|${action}|${timestamp}`;
            
            // Test QR API
            fetch('api/biometric_api.php?action=qr_scan&test_mode=true', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qr_data: qrData })
            })
            .then(response => response.json())
            .then(data => {
                showResult(`✅ QR Code API tested. Response: ${data.message}`, data.success ? 'success' : 'warning');
            })
            .catch(error => {
                showResult(`❌ QR Code Test Error: ${error.message}`, 'danger');
            });
        }
        
        function testMobileConnection() {
            showResult('Testing Mobile App connection...', 'info');
            
            const testData = {
                employee_id: parseInt(document.getElementById('testEmployeeId').value) || 1,
                device_id: 'TEST_DEVICE_001',
                app_version: '1.0.0'
            };
            
            fetch('api/biometric_api.php?action=mobile_checkin&test_mode=true', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                showResult(`✅ Mobile Connection tested. Response: ${data.message}`, data.success ? 'success' : 'warning');
            })
            .catch(error => {
                showResult(`❌ Mobile Connection Error: ${error.message}`, 'danger');
            });
        }
        
        function testFormSubmission() {
            showResult('Testing form submission to save_attendance.php...', 'info');
            
            // Create a test form
            const formData = new FormData();
            formData.append('attendance_date', new Date().toISOString().split('T')[0]);
            formData.append('employee_id[]', '1');
            formData.append('status[1]', 'Present');
            formData.append('time_in[1]', '09:00');
            formData.append('time_out[1]', '17:00');
            
            fetch('../../save_attendance.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                if (html.includes('success') || html.includes('saved')) {
                    showResult('✅ Form submission working! Attendance can be saved.', 'success');
                } else {
                    showResult('⚠️ Form submitted but response unclear. Check manually.', 'warning');
                }
            })
            .catch(error => {
                showResult(`❌ Form Submission Error: ${error.message}`, 'danger');
            });
        }
        
        function runCustomTest() {
            const employeeId = document.getElementById('testEmployeeId').value;
            const action = document.getElementById('testAction').value;
            const method = document.getElementById('testMethod').value;
            
            showResult(`Running custom test: ${action} for Employee ${employeeId} via ${method}`, 'info');
            
            const requestData = {
                employee_id: parseInt(employeeId),
                method: method
            };
            
            fetch(`api/biometric_api.php?action=${action}&test_mode=true`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                showResult(`Custom Test Result: ${data.message}`, data.success ? 'success' : 'warning');
            })
            .catch(error => {
                showResult(`❌ Custom Test Error: ${error.message}`, 'danger');
            });
        }
        
        function runAllTests() {
            showResult('🚀 Running all tests...', 'info');
            clearResults();
            
            setTimeout(() => testAPI('attendance_summary'), 500);
            setTimeout(() => testAPI('punch_in'), 1000);
            setTimeout(() => testAPI('punch_out'), 1500);
            setTimeout(() => testGeoLocation(), 2000);
            setTimeout(() => testQRCode(), 2500);
            setTimeout(() => testMobileConnection(), 3000);
            setTimeout(() => testFormSubmission(), 3500);
            
            setTimeout(() => {
                showResult('🎉 All tests completed! Check results above.', 'success');
            }, 4000);
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testCounter = 0;
        }
        
        // Login/Session Test Functions
        async function testLogin() {
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            showResult('🔄 Testing login...', 'info');
            
            try {
                const response = await fetch('test_login.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(`✅ Login successful: ${data.message}`, 'success');
                } else {
                    showResult(`❌ Login failed: ${data.message}`, 'danger');
                }
            } catch (error) {
                showResult(`❌ Login error: ${error.message}`, 'danger');
            }
        }
        
        async function checkLoginStatus() {
            showResult('🔄 Checking login status...', 'info');
            
            try {
                const response = await fetch('test_login.php?action=check_status');
                const data = await response.json();
                
                if (data.logged_in) {
                    showResult(`✅ Logged in as: ${data.user_type} (ID: ${data.user_id})`, 'success');
                } else {
                    showResult('❌ Not logged in', 'warning');
                }
            } catch (error) {
                showResult(`❌ Status check error: ${error.message}`, 'danger');
            }
        }
        
        async function testLogout() {
            showResult('🔄 Testing logout...', 'info');
            
            try {
                const response = await fetch('test_login.php?action=logout');
                const data = await response.json();
                
                showResult(`✅ ${data.message}`, 'success');
            } catch (error) {
                showResult(`❌ Logout error: ${error.message}`, 'danger');
            }
        }
        
        async function testAPIWithSession(apiAction) {
            showResult(`🔄 Testing ${apiAction} API with session authentication...`, 'info');
            
            const employeeId = document.getElementById('testEmployeeId').value || 1;
            let endpoint = '';
            let requestData = {};
            
            switch (apiAction) {
                case 'attendance_summary':
                    endpoint = 'api/biometric_api.php?action=attendance_summary';
                    requestData = { employee_id: parseInt(employeeId) };
                    break;
                case 'punch_in':
                    endpoint = 'api/biometric_api.php?action=punch_in';
                    requestData = { 
                        employee_id: parseInt(employeeId),
                        method: 'manual'
                    };
                    break;
                default:
                    showResult('❌ Unknown API action', 'danger');
                    return;
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(`✅ ${apiAction} API (session): ${data.message}`, 'success');
                } else {
                    showResult(`❌ ${apiAction} API (session): ${data.message}`, 'danger');
                }
            } catch (error) {
                showResult(`❌ ${apiAction} API Error: ${error.message}`, 'danger');
            }
        }
        
        // Auto-run basic tests on page load
        window.addEventListener('load', function() {
            showResult('🔧 Attendance System Test Page Loaded', 'success');
            showResult('Click buttons above to test different features', 'info');
        });
    </script>
</body>
</html>
