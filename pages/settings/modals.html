<!-- Settings Import/Export Modal -->
<div class="modal fade" id="importExportModal" tabindex="-1" aria-labelledby="importExportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importExportModalLabel">
                    <i class="bi bi-arrow-down-up"></i> Import/Export Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Export Settings -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-download"></i> Export Settings</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Download all system settings as a JSON file for backup or transfer purposes.</p>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="export_general" checked>
                                    <label class="form-check-label" for="export_general">
                                        General Settings
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="export_company" checked>
                                    <label class="form-check-label" for="export_company">
                                        Company Information
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="export_email" checked>
                                    <label class="form-check-label" for="export_email">
                                        Email Settings
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="export_security" checked>
                                    <label class="form-check-label" for="export_security">
                                        Security Settings
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="export_backup">
                                    <label class="form-check-label" for="export_backup">
                                        Backup Settings
                                    </label>
                                </div>
                                
                                <button class="btn btn-primary w-100" onclick="exportSettings()">
                                    <i class="bi bi-download"></i> Export Selected Settings
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Import Settings -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="bi bi-upload"></i> Import Settings</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Upload a previously exported settings file to restore system configuration.</p>
                                
                                <div class="mb-3">
                                    <label for="import_file" class="form-label">Select Settings File</label>
                                    <input type="file" class="form-control" id="import_file" accept=".json">
                                    <div class="form-text">Only JSON files are accepted</div>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="import_backup_current" checked>
                                    <label class="form-check-label" for="import_backup_current">
                                        Backup current settings before import
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="import_overwrite">
                                    <label class="form-check-label" for="import_overwrite">
                                        Overwrite existing settings
                                    </label>
                                </div>
                                
                                <div class="alert alert-warning" role="alert">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Warning:</strong> Importing settings will modify your system configuration. Make sure to backup current settings first.
                                </div>
                                
                                <button class="btn btn-success w-100" onclick="importSettings()">
                                    <i class="bi bi-upload"></i> Import Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Import Preview -->
                <div id="import_preview" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="bi bi-eye"></i> Import Preview</h6>
                        </div>
                        <div class="card-body">
                            <div id="preview_content"></div>
                            <div class="mt-3">
                                <button class="btn btn-success" onclick="confirmImport()">
                                    <i class="bi bi-check-circle"></i> Confirm Import
                                </button>
                                <button class="btn btn-secondary" onclick="cancelImport()">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- System Health Modal -->
<div class="modal fade" id="systemHealthModal" tabindex="-1" aria-labelledby="systemHealthModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="systemHealthModalLabel">
                    <i class="bi bi-shield-check"></i> System Health Check
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="healthCheckResults">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Running system health check...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="runHealthCheck()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Check
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Import/Export functionality
function exportSettings() {
    // Get selected categories
    const categories = [];
    if (document.getElementById('export_general').checked) categories.push('general');
    if (document.getElementById('export_company').checked) categories.push('company');
    if (document.getElementById('export_email').checked) categories.push('email');
    if (document.getElementById('export_security').checked) categories.push('security');
    if (document.getElementById('export_backup').checked) categories.push('backup');
    
    // Make AJAX request to export settings
    $.post('../../api/settings_api.php', {
        action: 'export_settings',
        categories: categories
    }, function(response) {
        if (response.success) {
            // Create and download the file
            const blob = new Blob([JSON.stringify(response.data, null, 2)], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = response.filename || 'settings_export.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('success', 'Settings exported successfully');
        } else {
            showAlert('danger', response.message || 'Export failed');
        }
    }).fail(function() {
        showAlert('danger', 'Export request failed');
    });
}

function importSettings() {
    const fileInput = document.getElementById('import_file');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('warning', 'Please select a file to import');
        return;
    }
    
    if (file.type !== 'application/json') {
        showAlert('warning', 'Please select a valid JSON file');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importData = JSON.parse(e.target.result);
            previewImport(importData);
        } catch (error) {
            showAlert('danger', 'Invalid JSON file format');
        }
    };
    reader.readAsText(file);
}

function previewImport(data) {
    if (!data.settings) {
        showAlert('danger', 'Invalid settings file format');
        return;
    }
    
    let previewHtml = '<h6>Settings to be imported:</h6><div class="table-responsive"><table class="table table-sm"><thead><tr><th>Setting</th><th>Current Value</th><th>New Value</th></tr></thead><tbody>';
    
    for (const [key, value] of Object.entries(data.settings)) {
        const currentValue = getCurrentSettingValue(key) || 'Not set';
        previewHtml += `<tr><td>${key}</td><td>${currentValue}</td><td>${value}</td></tr>`;
    }
    
    previewHtml += '</tbody></table></div>';
    previewHtml += `<p class="text-muted mt-2">Import date: ${data.export_date || 'Unknown'}</p>`;
    
    document.getElementById('preview_content').innerHTML = previewHtml;
    document.getElementById('import_preview').style.display = 'block';
    
    // Store data for confirmation
    window.pendingImport = data;
}

function getCurrentSettingValue(key) {
    // Get current value from the form inputs
    const input = document.querySelector(`[name="${key}"]`);
    return input ? input.value : '';
}

function confirmImport() {
    if (!window.pendingImport) {
        showAlert('danger', 'No import data available');
        return;
    }
    
    const backupCurrent = document.getElementById('import_backup_current').checked;
    const overwrite = document.getElementById('import_overwrite').checked;
    
    $.post('../../api/settings_api.php', {
        action: 'import_settings',
        json_data: JSON.stringify(window.pendingImport),
        backup_current: backupCurrent,
        overwrite: overwrite
    }, function(response) {
        if (response.success) {
            showAlert('success', response.message);
            $('#importExportModal').modal('hide');
            // Reload the page to show imported settings
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', response.message || 'Import failed');
        }
    }).fail(function() {
        showAlert('danger', 'Import request failed');
    });
}

function cancelImport() {
    document.getElementById('import_preview').style.display = 'none';
    window.pendingImport = null;
}

// System Health Check
function showSystemHealth() {
    $('#systemHealthModal').modal('show');
    runHealthCheck();
}

function runHealthCheck() {
    document.getElementById('healthCheckResults').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Running system health check...</p>
        </div>
    `;
    
    $.post('../../api/settings_api.php', {
        action: 'system_health_check'
    }, function(response) {
        if (response.success) {
            displayHealthResults(response.data);
        } else {
            document.getElementById('healthCheckResults').innerHTML = 
                '<div class="alert alert-danger">Failed to run health check: ' + (response.message || 'Unknown error') + '</div>';
        }
    }).fail(function() {
        document.getElementById('healthCheckResults').innerHTML = 
            '<div class="alert alert-danger">Health check request failed</div>';
    });
}

function displayHealthResults(health) {
    let html = `<div class="alert alert-${getStatusClass(health.overall_status)}">
        <h6><i class="bi bi-shield-${getStatusIcon(health.overall_status)}"></i> Overall Status: ${health.overall_status.toUpperCase()}</h6>
    </div>`;
    
    if (health.checks && health.checks.length > 0) {
        html += '<h6 class="text-success"><i class="bi bi-check-circle"></i> Passed Checks:</h6>';
        html += '<div class="row">';
        health.checks.forEach(check => {
            html += `<div class="col-md-6"><small class="text-success">✅ ${check.name}: ${check.status}</small></div>`;
        });
        html += '</div><br>';
    }
    
    if (health.warnings && health.warnings.length > 0) {
        html += '<h6 class="text-warning"><i class="bi bi-exclamation-triangle"></i> Warnings:</h6>';
        html += '<div class="row">';
        health.warnings.forEach(warning => {
            html += `<div class="col-md-6"><small class="text-warning">⚠️ ${warning.name}: ${warning.status}</small></div>`;
        });
        html += '</div><br>';
    }
    
    if (health.errors && health.errors.length > 0) {
        html += '<h6 class="text-danger"><i class="bi bi-exclamation-circle"></i> Errors:</h6>';
        html += '<div class="row">';
        health.errors.forEach(error => {
            html += `<div class="col-md-6"><small class="text-danger">❌ ${error.name}: ${error.status}</small></div>`;
        });
        html += '</div>';
    }
    
    document.getElementById('healthCheckResults').innerHTML = html;
}

function getStatusClass(status) {
    switch(status) {
        case 'healthy': return 'success';
        case 'warning': return 'warning';
        case 'critical': return 'danger';
        default: return 'info';
    }
}

function getStatusIcon(status) {
    switch(status) {
        case 'healthy': return 'check';
        case 'warning': return 'exclamation-triangle';
        case 'critical': return 'exclamation-octagon';
        default: return 'info-circle';
    }
}
</script>
