<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1><i class="bi bi-camera"></i> Camera Capture Test</h1>
        <p class="text-muted">Test camera functionality and image capture</p>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Camera Preview</h5>
                        <div id="cameraStatus" class="mt-2">
                            <span class="badge bg-secondary">Camera not started</span>
                        </div>
                    </div>
                    <div class="card-body text-center">
                        <video id="testVideo" width="100%" height="400" autoplay muted style="border: 2px solid #007bff; border-radius: 8px; background: #f8f9fa; max-width: 640px;"></video>
                        <canvas id="testCanvas" width="640" height="480" style="display: none;"></canvas>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary me-2" onclick="startCamera()">
                                <i class="bi bi-play"></i> Start Camera
                            </button>
                            <button type="button" class="btn btn-success me-2" onclick="captureImage()" id="captureBtn" disabled>
                                <i class="bi bi-camera"></i> Capture Image
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="stopCamera()">
                                <i class="bi bi-stop"></i> Stop Camera
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Captured Image</h5>
                    </div>
                    <div class="card-body">
                        <div id="capturedImageContainer">
                            <p class="text-muted text-center">No image captured yet</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Status Log</h5>
                    </div>
                    <div class="card-body">
                        <div id="statusLog" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            <div class="text-muted">Ready to test camera...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentStream = null;
        const video = document.getElementById('testVideo');
        const canvas = document.getElementById('testCanvas');
        const captureBtn = document.getElementById('captureBtn');
        const statusDiv = document.getElementById('cameraStatus');
        const logDiv = document.getElementById('statusLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function startCamera() {
            try {
                log('üé¨ Starting camera...');
                statusDiv.innerHTML = '<span class="badge bg-warning">Starting camera...</span>';
                
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    video.play().then(() => {
                        log('‚úÖ Camera started successfully');
                        log(`üìê Video size: ${video.videoWidth}x${video.videoHeight}`);
                        statusDiv.innerHTML = '<span class="badge bg-success">Camera active</span>';
                        captureBtn.disabled = false;
                    }).catch(error => {
                        log('‚ùå Video play error: ' + error.message);
                        statusDiv.innerHTML = '<span class="badge bg-danger">Video play failed</span>';
                    });
                };
                
            } catch (error) {
                log('‚ùå Camera error: ' + error.message);
                statusDiv.innerHTML = '<span class="badge bg-danger">Camera failed</span>';
                
                if (error.name === 'NotAllowedError') {
                    log('üö´ Camera permission denied');
                } else if (error.name === 'NotFoundError') {
                    log('üì∑ No camera found');
                } else if (error.name === 'NotReadableError') {
                    log('üîí Camera in use by another application');
                }
            }
        }
        
        function captureImage() {
            try {
                if (!video.videoWidth || !video.videoHeight) {
                    log('‚ùå Video not ready for capture');
                    return;
                }
                
                log('üì∏ Capturing image...');
                
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                const imageSize = Math.round(imageData.length * 0.75 / 1024); // Approximate size in KB
                
                log(`‚úÖ Image captured! Size: ${video.videoWidth}x${video.videoHeight}, Data: ${imageSize}KB`);
                
                // Display captured image
                document.getElementById('capturedImageContainer').innerHTML = `
                    <img src="${imageData}" class="img-fluid rounded" style="max-width: 100%;">
                    <small class="text-muted d-block mt-2">Size: ${video.videoWidth}x${video.videoHeight}</small>
                    <small class="text-muted d-block">Data: ${imageSize}KB</small>
                `;
                
            } catch (error) {
                log('‚ùå Capture error: ' + error.message);
            }
        }
        
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                log('üõë Camera stopped');
                statusDiv.innerHTML = '<span class="badge bg-secondary">Camera stopped</span>';
                captureBtn.disabled = true;
            }
        }
        
        // Check browser support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            log('‚ùå Camera API not supported in this browser');
            statusDiv.innerHTML = '<span class="badge bg-danger">Not supported</span>';
        } else {
            log('‚úÖ Camera API supported');
        }
    </script>
</body>
</html>
